<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Time & Currency</title>
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/plugin/utc.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/plugin/timezone.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; padding-bottom: 50px; }
        .card { box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .time-display { font-size: 1.2rem; font-weight: bold; }
        .conversion-display { font-size: 1.2rem; font-weight: bold; }
        #local-time { font-size: 1.3rem; }
        
        /* Country Search Styles */
        #country-select {
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            display: none;
            position: absolute;
            z-index: 1000;
            background: white;
        }
        
        #country-select option {
            padding: 8px 12px;
            cursor: pointer;
        }
        
        #country-select option:hover {
            background-color: #f8f9fa;
        }
        
        #country-select option[style*="display: none"] {
            display: none !important;
        }
        
        /* City Selector */
        #city-select-container {
            transition: all 0.3s ease;
        }
        
        .country-search-container {
            position: relative;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">
            <i class="bi bi-globe"></i> Global Time & Currency
            <small class="d-block text-muted fs-6">For travelers and digital nomads</small>
        </h1>
        
        <!-- Local Time Display -->
        <div class="card mb-4 bg-light">
            <div class="card-body text-center py-3">
                <div id="local-time">
                    <span class="badge bg-primary me-2">Your Local Time</span>
                    <span id="current-local-time">Loading...</span>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- Timezone Column -->
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h2 class="h5 mb-0"><i class="bi bi-clock"></i> World Clock</h2>
                    </div>
                    <div class="card-body">
                        <div class="mb-3 country-search-container">
                            <label class="form-label">Search Country:</label>
                            <input type="text" id="country-search" class="form-control" placeholder="Start typing a country name...">
                            <select class="form-select mt-1" id="country-select" size="5"></select>
                        </div>
                        
                        <div class="mb-3" id="city-select-container" style="display:none;">
                            <label class="form-label">Select City/Timezone:</label>
                            <select class="form-select" id="city-select"></select>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button onclick="showSelectedTime()" class="btn btn-primary flex-grow-1">
                                <i class="bi bi-eye"></i> Show Time
                            </button>
                            <button onclick="startLiveTime()" class="btn btn-outline-primary">
                                <i class="bi bi-arrow-repeat"></i> Live
                            </button>
                            <button onclick="pinTimezone()" class="btn btn-success">
                                <i class="bi bi-pin"></i> Pin
                            </button>
                        </div>
                        
                        <div id="time-result" class="time-display mt-3 p-3 bg-light rounded"></div>
                    </div>
                </div>
            </div>
            
            <!-- Currency Column -->
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h2 class="h5 mb-0"><i class="bi bi-cash-stack"></i> Currency Converter</h2>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Amount:</label>
                                <input type="number" class="form-control" id="amount" value="1" min="0" step="0.01">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">From:</label>
                                <select class="form-select" id="from-currency">
                                    <option value="USD">USD - US Dollar</option>
                                    <option value="EUR">EUR - Euro</option>
                                    <option value="KHR">KHR - Cambodian Riel</option>
                                    <option value="THB">THB - Thai Baht</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">To:</label>
                                <select class="form-select" id="to-currency">
                                    <option value="KHR">KHR - Cambodian Riel</option>
                                    <option value="USD">USD - US Dollar</option>
                                    <option value="EUR">EUR - Euro</option>
                                    <option value="THB">THB - Thai Baht</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2 mt-3">
                            <button onclick="convertCurrency()" class="btn btn-success flex-grow-1">
                                <i class="bi bi-arrow-left-right"></i> Convert
                            </button>
                            <button onclick="swapCurrencies()" class="btn btn-outline-success">
                                <i class="bi bi-swap"></i> Swap
                            </button>
                            <button onclick="pinCurrency()" class="btn btn-primary">
                                <i class="bi bi-pin"></i> Pin
                            </button>
                        </div>
                        
                        <div id="conversion-result" class="conversion-display mt-3 p-3 bg-light rounded"></div>
                        
                        <!-- Hardcoded KHR rates -->
                        <div class="mt-4">
                            <h6 class="text-muted">Approximate KHR Rates:</h6>
                            <ul class="list-group">
                                <li class="list-group-item">1 USD ≈ 4,100 KHR</li>
                                <li class="list-group-item">1 EUR ≈ 4,400 KHR</li>
                                <li class="list-group-item">1 THB ≈ 110 KHR</li>
                            </ul>
                            <p class="text-muted small mt-2">Rates update when online API works</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pinned Items Section -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h2 class="h5 mb-0"><i class="bi bi-pin-angle"></i> Pinned Items</h2>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h3 class="h6">Pinned Timezones</h3>
                        <div id="pinned-timezones" class="list-group"></div>
                    </div>
                    <div class="col-md-6">
                        <h3 class="h6">Pinned Currencies</h3>
                        <div id="pinned-currencies" class="list-group"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Day.js plugins
        dayjs.extend(dayjs_plugin_utc);
        dayjs.extend(dayjs_plugin_timezone);
        
        // Store pinned items
        let pinnedItems = {
            timezones: [],
            currencies: []
        };
        
        // ======================
        // COUNTRY SEARCH FUNCTIONALITY
        // ======================
        
        // Comprehensive country and timezone data
        const countryData = [
            { code: 'KH', name: 'Cambodia', timezones: ['Asia/Phnom_Penh'] },
            { code: 'US', name: 'United States', timezones: [
                'America/New_York', 'America/Chicago', 'America/Denver', 
                'America/Los_Angeles', 'America/Anchorage', 'Pacific/Honolulu'
            ]},
            { code: 'GB', name: 'United Kingdom', timezones: ['Europe/London'] },
            { code: 'JP', name: 'Japan', timezones: ['Asia/Tokyo'] },
            { code: 'AU', name: 'Australia', timezones: [
                'Australia/Sydney', 'Australia/Melbourne', 'Australia/Brisbane',
                'Australia/Adelaide', 'Australia/Perth', 'Australia/Darwin'
            ]},
            { code: 'TH', name: 'Thailand', timezones: ['Asia/Bangkok'] },
            { code: 'VN', name: 'Vietnam', timezones: ['Asia/Ho_Chi_Minh'] },
            { code: 'LA', name: 'Laos', timezones: ['Asia/Vientiane'] },
            { code: 'SG', name: 'Singapore', timezones: ['Asia/Singapore'] },
            { code: 'CN', name: 'China', timezones: ['Asia/Shanghai'] },
            { code: 'IN', name: 'India', timezones: ['Asia/Kolkata'] },
            { code: 'FR', name: 'France', timezones: ['Europe/Paris'] },
            { code: 'DE', name: 'Germany', timezones: ['Europe/Berlin'] },
            { code: 'IT', name: 'Italy', timezones: ['Europe/Rome'] },
            { code: 'ES', name: 'Spain', timezones: ['Europe/Madrid'] },
            { code: 'RU', name: 'Russia', timezones: ['Europe/Moscow'] },
            { code: 'BR', name: 'Brazil', timezones: ['America/Sao_Paulo'] },
            { code: 'CA', name: 'Canada', timezones: ['America/Toronto', 'America/Vancouver'] },
            { code: 'MX', name: 'Mexico', timezones: ['America/Mexico_City'] },
            // Add more countries as needed...
        ];
        
        // Initialize country search
        function initCountrySearch() {
            const countrySelect = document.getElementById('country-select');
            
            // Sort countries alphabetically
            countryData.sort((a, b) => a.name.localeCompare(b.name));
            
            // Populate country dropdown
            countryData.forEach(country => {
                const option = document.createElement('option');
                option.value = country.code;
                option.textContent = country.name;
                countrySelect.appendChild(option);
            });
            
            // Show dropdown when search input is focused or has value
            document.getElementById('country-search').addEventListener('focus', function() {
                document.getElementById('country-select').style.display = 'block';
                filterCountries();
            });
            
            document.getElementById('country-search').addEventListener('input', function() {
                document.getElementById('country-select').style.display = 'block';
                filterCountries();
            });
            
            // Hide dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.country-search-container')) {
                    document.getElementById('country-select').style.display = 'none';
                }
            });
            
            // Handle country selection
            document.getElementById('country-select').addEventListener('change', function() {
                updateCities();
            });
        }
        
        // Filter countries based on search input
        function filterCountries() {
            const searchTerm = document.getElementById('country-search').value.toLowerCase();
            const options = document.getElementById('country-select').options;
            
            let hasMatches = false;
            
            for (let i = 0; i < options.length; i++) {
                const option = options[i];
                if (option.textContent.toLowerCase().includes(searchTerm)) {
                    option.style.display = 'block';
                    hasMatches = true;
                } else {
                    option.style.display = 'none';
                }
            }
            
            // If no matches, show a message
            if (!hasMatches) {
                const noResults = document.createElement('option');
                noResults.textContent = 'No countries found';
                noResults.disabled = true;
                document.getElementById('country-select').appendChild(noResults);
            }
        }
        
        // Update cities when country is selected
        function updateCities() {
            const countryCode = document.getElementById('country-select').value;
            const citySelect = document.getElementById('city-select');
            const cityContainer = document.getElementById('city-select-container');
            
            citySelect.innerHTML = '<option value="">Select a city</option>';
            cityContainer.style.display = 'none';
            
            if (!countryCode) return;
            
            // Set the search input to the selected country
            const countryName = document.getElementById('country-select')
                .options[document.getElementById('country-select').selectedIndex].text;
            document.getElementById('country-search').value = countryName;
            
            // Hide the country dropdown
            document.getElementById('country-select').style.display = 'none';
            
            // Show cities for the selected country
            const country = countryData.find(c => c.code === countryCode);
            if (country && country.timezones.length > 0) {
                cityContainer.style.display = 'block';
                
                country.timezones.forEach(timezone => {
                    const cityName = timezone.split('/')[1].replace(/_/g, ' ');
                    const option = document.createElement('option');
                    option.value = timezone;
                    option.textContent = cityName;
                    citySelect.appendChild(option);
                });
            }
        }
        
        // ======================
        // TIME FUNCTIONS
        // ======================
        
        // Show local time
        function updateLocalTime() {
            const now = dayjs();
            document.getElementById('current-local-time').textContent = 
                now.format('h:mm:ss A ddd, MMM D, YYYY');
        }
        
        // Show selected timezone time
        function showSelectedTime() {
            const timezone = document.getElementById('city-select').value;
            if (!timezone) {
                alert("Please select a city/timezone first");
                return;
            }
            
            const cityName = document.getElementById('city-select').options[document.getElementById('city-select').selectedIndex].text;
            const countryName = document.getElementById('country-search').value;
            
            getCurrentTime(timezone)
                .then(time => {
                    document.getElementById('time-result').textContent = 
                        `${countryName} - ${cityName}: ${time}`;
                })
                .catch(error => {
                    document.getElementById('time-result').textContent = 
                        `Error: Couldn't get time for ${cityName}`;
                });
        }
        
        // Start live updates for timezone
        function startLiveTime() {
            const timezone = document.getElementById('city-select').value;
            if (!timezone) {
                alert("Please select a city/timezone first");
                return;
            }
            
            const cityName = document.getElementById('city-select').options[document.getElementById('city-select').selectedIndex].text;
            const countryName = document.getElementById('country-search').value;
            
            // Update immediately
            getCurrentTime(timezone)
                .then(time => {
                    document.getElementById('time-result').textContent = 
                        `${countryName} - ${cityName}: ${time}`;
                });
            
            // Update every second
            const intervalId = setInterval(() => {
                getCurrentTime(timezone)
                    .then(time => {
                        document.getElementById('time-result').textContent = 
                            `${countryName} - ${cityName}: ${time}`;
                    });
            }, 1000);
            
            // Store interval ID to clear later
            document.getElementById('time-result').dataset.intervalId = intervalId;
        }
        
        // Pin a timezone
        function pinTimezone() {
            const timezone = document.getElementById('city-select').value;
            if (!timezone) {
                alert("Please select a city/timezone first");
                return;
            }
            
            const cityName = document.getElementById('city-select').options[document.getElementById('city-select').selectedIndex].text;
            const countryName = document.getElementById('country-search').value;
            
            if (!pinnedItems.timezones.some(tz => tz.id === timezone)) {
                pinnedItems.timezones.push({
                    id: timezone,
                    name: `${countryName} - ${cityName}`
                });
                savePinnedItems();
                renderPinnedItems();
            }
        }
        
        // ======================
        // CURRENCY FUNCTIONS
        // ======================
        
        // Convert currency
        function convertCurrency() {
            const from = document.getElementById('from-currency').value;
            const to = document.getElementById('to-currency').value;
            const amount = document.getElementById('amount').value || 1;
            const fromName = document.getElementById('from-currency').options[document.getElementById('from-currency').selectedIndex].text;
            const toName = document.getElementById('to-currency').options[document.getElementById('to-currency').selectedIndex].text;
            
            document.getElementById('conversion-result').textContent = "Converting...";
            
            getCurrencyConversion(from, to, amount)
                .then(result => {
                    if (result === "N/A") {
                        document.getElementById('conversion-result').textContent = 
                            "API unavailable. Using approximate rate.";
                        showApproximateRate(from, to, amount);
                    } else {
                        document.getElementById('conversion-result').textContent = 
                            `${amount} ${from} = ${result} ${to}`;
                    }
                })
                .catch(error => {
                    document.getElementById('conversion-result').textContent = 
                        "Conversion failed. Using approximate rate.";
                    showApproximateRate(from, to, amount);
                });
        }
        
        // Show approximate rate when API fails
        function showApproximateRate(from, to, amount) {
            const approximateRates = {
                USD_KHR: 4100,
                EUR_KHR: 4400,
                KHR_USD: 0.00024,
                KHR_EUR: 0.00023,
                USD_THB: 35,
                THB_USD: 0.029,
                EUR_THB: 38,
                THB_EUR: 0.026,
                KHR_THB: 0.0091,
                THB_KHR: 110
            };
            
            const rateKey = `${from}_${to}`;
            if (approximateRates[rateKey]) {
                const result = (amount * approximateRates[rateKey]).toFixed(4);
                document.getElementById('conversion-result').textContent += 
                    `\nApproximate: ${amount} ${from} ≈ ${result} ${to}`;
            }
        }
        
        // Swap currency conversion
        function swapCurrencies() {
            const from = document.getElementById('from-currency');
            const to = document.getElementById('to-currency');
            const temp = from.value;
            from.value = to.value;
            to.value = temp;
            convertCurrency();
        }
        
        // Pin a currency pair
        function pinCurrency() {
            const from = document.getElementById('from-currency').value;
            const to = document.getElementById('to-currency').value;
            const fromName = document.getElementById('from-currency').options[document.getElementById('from-currency').selectedIndex].text;
            const toName = document.getElementById('to-currency').options[document.getElementById('to-currency').selectedIndex].text;
            const id = `${from}_${to}`;
            
            if (!pinnedItems.currencies.some(curr => curr.id === id)) {
                pinnedItems.currencies.push({
                    id: id,
                    from: from,
                    to: to,
                    fromName: fromName,
                    toName: toName
                });
                savePinnedItems();
                renderPinnedItems();
            }
        }
        
        // ======================
        // API FUNCTIONS
        // ======================
        
        // Get current time for a timezone
        async function getCurrentTime(timezone) {
            try {
                // Try WorldTimeAPI first
                const response = await fetch(`https://worldtimeapi.org/api/timezone/${timezone}`);
                if (response.ok) {
                    const data = await response.json();
                    const date = new Date(data.datetime);
                    return date.toLocaleTimeString('en-US', {
                        timeZone: timezone,
                        hour12: false,
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                }
                
                // Fallback to Day.js calculation
                return dayjs().tz(timezone).format('HH:mm:ss');
                
            } catch (error) {
                // Final fallback
                return dayjs().tz(timezone).format('HH:mm:ss');
            }
        }
        
        // Get currency conversion
        async function getCurrencyConversion(from, to, amount) {
            try {
                // Try ExchangeRate-API
                const response = await fetch(`https://open.er-api.com/v6/latest/${from}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.rates && data.rates[to]) {
                        return (amount * data.rates[to]).toFixed(4);
                    }
                }
                
                // Try alternative API
                const altResponse = await fetch(`https://cdn.jsdelivr.net/gh/fawazahmed0/currency-api@1/latest/currencies/${from}/${to}.json`);
                if (altResponse.ok) {
                    const altData = await altResponse.json();
                    if (altData[to]) {
                        return (amount * altData[to]).toFixed(4);
                    }
                }
                
                return "N/A";
                
            } catch (error) {
                return "N/A";
            }
        }
        
        // ======================
        // PINNED ITEMS MANAGEMENT
        // ======================
        
        // Load pinned items from localStorage
        function loadPinnedItems() {
            const saved = localStorage.getItem('pinnedItems');
            if (saved) {
                pinnedItems = JSON.parse(saved);
                renderPinnedItems();
                
                // Start updates for pinned items
                startPinnedItemsUpdates();
            }
        }
        
        // Save pinned items to localStorage
        function savePinnedItems() {
            localStorage.setItem('pinnedItems', JSON.stringify(pinnedItems));
        }
        
        // Render all pinned items
        function renderPinnedItems() {
            renderPinnedTimezones();
            renderPinnedCurrencies();
        }
        
        // Render pinned timezones
        function renderPinnedTimezones() {
            const container = document.getElementById('pinned-timezones');
            container.innerHTML = '';
            
            pinnedItems.timezones.forEach(tz => {
                const item = document.createElement('div');
                item.className = 'list-group-item d-flex justify-content-between align-items-center';
                item.id = `pinned-tz-${tz.id.replace(/\//g, '-')}`;
                
                const content = document.createElement('div');
                content.innerHTML = `<strong>${tz.name}</strong><div class="time-display">Loading...</div>`;
                
                const button = document.createElement('button');
                button.className = 'btn btn-sm btn-danger';
                button.innerHTML = '<i class="bi bi-x"></i>';
                button.onclick = () => {
                    pinnedItems.timezones = pinnedItems.timezones.filter(item => item.id !== tz.id);
                    savePinnedItems();
                    renderPinnedItems();
                };
                
                item.appendChild(content);
                item.appendChild(button);
                container.appendChild(item);
                
                // Start updating this timezone
                updatePinnedTimezone(tz.id, content);
            });
        }
        
        // Render pinned currencies
        function renderPinnedCurrencies() {
            const container = document.getElementById('pinned-currencies');
            container.innerHTML = '';
            
            pinnedItems.currencies.forEach(curr => {
                const item = document.createElement('div');
                item.className = 'list-group-item d-flex justify-content-between align-items-center';
                item.id = `pinned-curr-${curr.id}`;
                
                const content = document.createElement('div');
                content.innerHTML = `<strong>${curr.fromName} → ${curr.toName}</strong><div class="conversion-display">Loading...</div>`;
                
                const button = document.createElement('button');
                button.className = 'btn btn-sm btn-danger';
                button.innerHTML = '<i class="bi bi-x"></i>';
                button.onclick = () => {
                    pinnedItems.currencies = pinnedItems.currencies.filter(item => item.id !== curr.id);
                    savePinnedItems();
                    renderPinnedItems();
                };
                
                item.appendChild(content);
                item.appendChild(button);
                container.appendChild(item);
                
                // Start updating this currency
                updatePinnedCurrency(curr.from, curr.to, content);
            });
        }
        
        // Start updates for all pinned items
        function startPinnedItemsUpdates() {
            pinnedItems.timezones.forEach(tz => {
                const element = document.getElementById(`pinned-tz-${tz.id.replace(/\//g, '-')}`);
                if (element) {
                    updatePinnedTimezone(tz.id, element.querySelector('div'));
                }
            });
            
            pinnedItems.currencies.forEach(curr => {
                const element = document.getElementById(`pinned-curr-${curr.id}`);
                if (element) {
                    updatePinnedCurrency(curr.from, curr.to, element.querySelector('div'));
                }
            });
        }
        
        // Update a pinned timezone
        function updatePinnedTimezone(timezone, element) {
            getCurrentTime(timezone)
                .then(time => {
                    if (element) element.textContent = time;
                });
            
            // Update every second
            const intervalId = setInterval(() => {
                getCurrentTime(timezone)
                    .then(time => {
                        if (element) element.textContent = time;
                    });
            }, 1000);
            
            // Store interval ID on element
            if (element) element.dataset.intervalId = intervalId;
        }
        
        // Update a pinned currency
        function updatePinnedCurrency(from, to, element) {
            getCurrencyConversion(from, to, 1)
                .then(result => {
                    if (element) {
                        if (result === "N/A") {
                            element.textContent = "Rate unavailable";
                        } else {
                            element.textContent = `1 ${from} = ${result} ${to}`;
                        }
                    }
                });
            
            // Update every minute
            const intervalId = setInterval(() => {
                getCurrencyConversion(from, to, 1)
                    .then(result => {
                        if (element) {
                            if (result === "N/A") {
                                element.textContent = "Rate unavailable";
                            } else {
                                element.textContent = `1 ${from} = ${result} ${to}`;
                            }
                        }
                    });
            }, 60000);
            
            // Store interval ID on element
            if (element) element.dataset.intervalId = intervalId;
        }
        
        // ======================
        // INITIALIZATION
        // ======================
        
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize time display
            updateLocalTime();
            setInterval(updateLocalTime, 1000);
            
            // Initialize country search
            initCountrySearch();
            
            // Load pinned items
            loadPinnedItems();
        });
    </script>
</body>
</html>