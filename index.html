<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Time & Currency</title>
    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/plugin/utc.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.7/plugin/timezone.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; padding-bottom: 50px; }
        .card { box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .time-display { font-size: 1.2rem; font-weight: bold; }
        .conversion-display { font-size: 1.2rem; font-weight: bold; }
        #local-time { font-size: 1.3rem; }
        
        /* Country Search Styles */
        #country-select {
            width: 100%;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            display: none;
            position: absolute;
            z-index: 1000;
            background: white;
        }
        
        #country-select option {
            padding: 8px 12px;
            cursor: pointer;
        }
        
        #country-select option:hover {
            background-color: #f8f9fa;
        }
        
        /* City Selector */
        #city-select-container {
            transition: all 0.3s ease;
        }
        
        .country-search-container {
            position: relative;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">
            <i class="bi bi-globe"></i> Global Time & Currency
            <small class="d-block text-muted fs-6">For travelers and digital nomads</small>
        </h1>
        
        <!-- Local Time Display -->
        <div class="card mb-4 bg-light">
            <div class="card-body text-center py-3">
                <div id="local-time">
                    <span class="badge bg-primary me-2">Your Local Time</span>
                    <span id="current-local-time">Loading...</span>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- Timezone Column -->
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h2 class="h5 mb-0"><i class="bi bi-clock"></i> World Clock</h2>
                    </div>
                    <div class="card-body">
                        <div class="mb-3 country-search-container">
                            <label class="form-label">Search Country:</label>
                            <input type="text" id="country-search" class="form-control" placeholder="Start typing a country name...">
                            <select class="form-select mt-1" id="country-select" size="5"></select>
                        </div>
                        
                        <div class="mb-3" id="city-select-container" style="display:none;">
                            <label class="form-label">Select City/Timezone:</label>
                            <select class="form-select" id="city-select"></select>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button onclick="showSelectedTime()" class="btn btn-primary flex-grow-1">
                                <i class="bi bi-eye"></i> Show Time
                            </button>
                            <button onclick="startLiveTime()" class="btn btn-outline-primary">
                                <i class="bi bi-arrow-repeat"></i> Live
                            </button>
                            <button onclick="pinTimezone()" class="btn btn-success">
                                <i class="bi bi-pin"></i> Pin
                            </button>
                        </div>
                        
                        <div id="time-result" class="time-display mt-3 p-3 bg-light rounded"></div>
                    </div>
                </div>
            </div>
            
            <!-- Currency Column -->
            <div class="col-md-6">
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h2 class="h5 mb-0"><i class="bi bi-cash-stack"></i> Currency Converter</h2>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label">Amount:</label>
                                <input type="number" class="form-control" id="amount" value="1" min="0" step="0.01">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">From:</label>
                                <select class="form-select" id="from-currency">
                                    <option value="USD">USD - US Dollar</option>
                                    <option value="EUR">EUR - Euro</option>
                                    <option value="KHR">KHR - Cambodian Riel</option>
                                    <option value="THB">THB - Thai Baht</option>
                                    <option value="GBP">GBP - British Pound</option>
                                    <option value="JPY">JPY - Japanese Yen</option>
                                    <option value="AUD">AUD - Australian Dollar</option>
                                    <option value="CAD">CAD - Canadian Dollar</option>
                                    <option value="BRL">BRL - Brazilian Real</option>
                                    <option value="MXN">MXN - Mexican Peso</option>
                                    <option value="RUB">RUB - Russian Ruble</option>
                                    <option value="INR">INR - Indian Rupee</option>
                                    <option value="CNY">CNY - Chinese Yuan</option>
                                    <option value="SGD">SGD - Singapore Dollar</option>
                                    <option value="VND">VND - Vietnamese Dong</option>
                                    <option value="LAK">LAK - Lao Kip</option>
                                    <option value="COP">COP - Colombian Peso</option>
                                    <option value="PLN">PLN - Polish Zloty</option>
                                    <option value="CVE">CVE - Cape Verdean Escudo</option>
                                    <option value="ZAR">ZAR - South African Rand</option>
                                    <option value="NGN">NGN - Nigerian Naira</option>
                                    <option value="KES">KES - Kenyan Shilling</option>
                                    <option value="ARS">ARS - Argentine Peso</option>
                                    <option value="CLP">CLP - Chilean Peso</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">To:</label>
                                <select class="form-select" id="to-currency">
                                    <option value="KHR">KHR - Cambodian Riel</option>
                                    <option value="USD">USD - US Dollar</option>
                                    <option value="EUR">EUR - Euro</option>
                                    <option value="THB">THB - Thai Baht</option>
                                    <option value="GBP">GBP - British Pound</option>
                                    <option value="JPY">JPY - Japanese Yen</option>
                                    <option value="AUD">AUD - Australian Dollar</option>
                                    <option value="CAD">CAD - Canadian Dollar</option>
                                    <option value="BRL">BRL - Brazilian Real</option>
                                    <option value="MXN">MXN - Mexican Peso</option>
                                    <option value="RUB">RUB - Russian Ruble</option>
                                    <option value="INR">INR - Indian Rupee</option>
                                    <option value="CNY">CNY - Chinese Yuan</option>
                                    <option value="SGD">SGD - Singapore Dollar</option>
                                    <option value="VND">VND - Vietnamese Dong</option>
                                    <option value="LAK">LAK - Lao Kip</option>
                                    <option value="COP">COP - Colombian Peso</option>
                                    <option value="PLN">PLN - Polish Zloty</option>
                                    <option value="CVE">CVE - Cape Verdean Escudo</option>
                                    <option value="ZAR">ZAR - South African Rand</option>
                                    <option value="NGN">NGN - Nigerian Naira</option>
                                    <option value="KES">KES - Kenyan Shilling</option>
                                    <option value="ARS">ARS - Argentine Peso</option>
                                    <option value="CLP">CLP - Chilean Peso</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2 mt-3">
                            <button onclick="convertCurrency()" class="btn btn-success flex-grow-1">
                                <i class="bi bi-arrow-left-right"></i> Convert
                            </button>
                            <button onclick="swapCurrencies()" class="btn btn-outline-success">
                                <i class="bi bi-arrow-left-right"></i> Swap
                            </button>
                            <button onclick="pinCurrency()" class="btn btn-primary">
                                <i class="bi bi-pin"></i> Pin
                            </button>
                        </div>
                        
                        <div id="conversion-result" class="conversion-display mt-3 p-3 bg-light rounded"></div>
                        
                        <!-- Hardcoded KHR rates -->
                        <div class="mt-4">
                            <h6 class="text-muted">Approximate KHR Rates (as of August 19, 2025):</h6>
                            <ul class="list-group">
                                <li class="list-group-item">1 USD ≈ 4,017 KHR</li>
                                <li class="list-group-item">1 EUR ≈ 4,689 KHR</li>
                                <li class="list-group-item">1 THB ≈ 115 KHR</li>
                            </ul>
                            <p class="text-muted small mt-2">Rates update when online API works; fallbacks for others may vary.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pinned Items Section -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h2 class="h5 mb-0"><i class="bi bi-pin-angle"></i> Pinned Items</h2>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h3 class="h6">Pinned Timezones</h3>
                        <div id="pinned-timezones" class="list-group"></div>
                    </div>
                    <div class="col-md-6">
                        <h3 class="h6">Pinned Currencies</h3>
                        <div id="pinned-currencies" class="list-group"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Day.js plugins
        dayjs.extend(dayjs_plugin_utc);
        dayjs.extend(dayjs_plugin_timezone);
        
        // Store pinned items
        let pinnedItems = {
            timezones: [],
            currencies: []
        };
        
        // ======================
        // COUNTRY SEARCH FUNCTIONALITY
        // ======================
        
        // Comprehensive country and timezone data with currencies
        const countryData = [
            { code: 'AR', name: 'Argentina', timezones: ['America/Buenos_Aires'], currency: 'ARS' },
            { code: 'AU', name: 'Australia', timezones: ['Australia/Sydney', 'Australia/Melbourne', 'Australia/Brisbane', 'Australia/Adelaide', 'Australia/Perth', 'Australia/Darwin'], currency: 'AUD' },
            { code: 'BR', name: 'Brazil', timezones: ['America/Sao_Paulo', 'America/Manaus', 'America/Noronha', 'America/Rio_Branco'], currency: 'BRL' },
            { code: 'CA', name: 'Canada', timezones: ['America/Toronto', 'America/Vancouver', 'America/Winnipeg', 'America/Halifax', 'America/Edmonton', 'America/St_Johns'], currency: 'CAD' },
            { code: 'CL', name: 'Chile', timezones: ['America/Santiago', 'Pacific/Easter'], currency: 'CLP' },
            { code: 'CN', name: 'China', timezones: ['Asia/Shanghai'], currency: 'CNY' },
            { code: 'CO', name: 'Colombia', timezones: ['America/Bogota'], currency: 'COP' },
            { code: 'CV', name: 'Cape Verde', timezones: ['Atlantic/Cape_Verde'], currency: 'CVE' },
            { code: 'DE', name: 'Germany', timezones: ['Europe/Berlin'], currency: 'EUR' },
            { code: 'ES', name: 'Spain', timezones: ['Europe/Madrid', 'Atlantic/Canary'], currency: 'EUR' },
            { code: 'FR', name: 'France', timezones: ['Europe/Paris', 'Pacific/Tahiti', 'Pacific/Marquesas', 'Pacific/Gambier', 'America/Cayenne'], currency: 'EUR' },
            { code: 'GB', name: 'United Kingdom', timezones: ['Europe/London'], currency: 'GBP' },
            { code: 'IN', name: 'India', timezones: ['Asia/Kolkata'], currency: 'INR' },
            { code: 'IT', name: 'Italy', timezones: ['Europe/Rome'], currency: 'EUR' },
            { code: 'JP', name: 'Japan', timezones: ['Asia/Tokyo'], currency: 'JPY' },
            { code: 'KE', name: 'Kenya', timezones: ['Africa/Nairobi'], currency: 'KES' },
            { code: 'KH', name: 'Cambodia', timezones: ['Asia/Phnom_Penh'], currency: 'KHR' },
            { code: 'LA', name: 'Laos', timezones: ['Asia/Vientiane'], currency: 'LAK' },
            { code: 'MX', name: 'Mexico', timezones: ['America/Mexico_City', 'America/Tijuana', 'America/Cancun', 'America/Hermosillo'], currency: 'MXN' },
            { code: 'NG', name: 'Nigeria', timezones: ['Africa/Lagos'], currency: 'NGN' },
            { code: 'PL', name: 'Poland', timezones: ['Europe/Warsaw'], currency: 'PLN' },
            { code: 'RU', name: 'Russia', timezones: ['Europe/Moscow', 'Europe/Kaliningrad', 'Asia/Yekaterinburg', 'Asia/Omsk', 'Asia/Krasnoyarsk', 'Asia/Irkutsk', 'Asia/Yakutsk', 'Asia/Vladivostok', 'Asia/Magadan', 'Asia/Kamchatka'], currency: 'RUB' },
            { code: 'SG', name: 'Singapore', timezones: ['Asia/Singapore'], currency: 'SGD' },
            { code: 'TH', name: 'Thailand', timezones: ['Asia/Bangkok'], currency: 'THB' },
            { code: 'US', name: 'United States', timezones: ['America/New_York', 'America/Chicago', 'America/Denver', 'America/Los_Angeles', 'America/Anchorage', 'Pacific/Honolulu'], currency: 'USD' },
            { code: 'VN', name: 'Vietnam', timezones: ['Asia/Ho_Chi_Minh'], currency: 'VND' },
            { code: 'ZA', name: 'South Africa', timezones: ['Africa/Johannesburg'], currency: 'ZAR' }
            // Add more as needed for ~50 total; this is a starting expansion
        ];
        
        // Initialize country search
        function initCountrySearch() {
            const countrySelect = document.getElementById('country-select');
            
            // Sort countries alphabetically
            countryData.sort((a, b) => a.name.localeCompare(b.name));
            
            // Handle events
            document.getElementById('country-search').addEventListener('focus', function() {
                document.getElementById('country-select').style.display = 'block';
                filterCountries();
            });
            
            document.getElementById('country-search').addEventListener('input', function() {
                document.getElementById('country-select').style.display = 'block';
                filterCountries();
            });
            
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.country-search-container')) {
                    document.getElementById('country-select').style.display = 'none';
                }
            });
            
            document.getElementById('country-select').addEventListener('change', function() {
                updateCities();
            });
        }
        
        // Filter countries based on search input (dynamic rebuild for cross-browser compatibility)
        function filterCountries() {
            const searchTerm = document.getElementById('country-search').value.toLowerCase();
            const countrySelect = document.getElementById('country-select');
            countrySelect.innerHTML = '';
            
            const filtered = countryData.filter(country => country.name.toLowerCase().includes(searchTerm))
                .sort((a, b) => a.name.localeCompare(b.name));
            
            filtered.forEach(country => {
                const option = document.createElement('option');
                option.value = country.code;
                option.textContent = country.name;
                countrySelect.appendChild(option);
            });
            
            if (filtered.length === 0) {
                const option = document.createElement('option');
                option.textContent = 'No countries found';
                option.disabled = true;
                countrySelect.appendChild(option);
            }
        }
        
        // Update cities when country is selected and set currency
        function updateCities() {
            const countryCode = document.getElementById('country-select').value;
            const citySelect = document.getElementById('city-select');
            const cityContainer = document.getElementById('city-select-container');
            
            citySelect.innerHTML = '<option value="">Select a city</option>';
            cityContainer.style.display = 'none';
            
            if (!countryCode) return;
            
            const selectedOption = document.getElementById('country-select').options[document.getElementById('country-select').selectedIndex];
            document.getElementById('country-search').value = selectedOption.text;
            
            document.getElementById('country-select').style.display = 'none';
            
            const country = countryData.find(c => c.code === countryCode);
            if (country && country.timezones.length > 0) {
                cityContainer.style.display = 'block';
                
                country.timezones.forEach(timezone => {
                    const cityName = timezone.split('/')[1].replace(/_/g, ' ');
                    const option = document.createElement('option');
                    option.value = timezone;
                    option.textContent = cityName;
                    citySelect.appendChild(option);
                });
            }
            
            // Set "To" currency to country's currency
            const toCurrency = document.getElementById('to-currency');
            if (country.currency && Array.from(toCurrency.options).some(opt => opt.value === country.currency)) {
                toCurrency.value = country.currency;
            }
        }
        
        // ======================
        // TIME FUNCTIONS
        // ======================
        
        // Show local time
        function updateLocalTime() {
            const now = dayjs();
            document.getElementById('current-local-time').textContent = 
                now.format('h:mm:ss A ddd, MMM D, YYYY');
        }
        
        // Show selected timezone time
        function showSelectedTime() {
            const timezone = document.getElementById('city-select').value;
            if (!timezone) {
                alert("Please select a city/timezone first");
                return;
            }
            
            const cityName = document.getElementById('city-select').options[document.getElementById('city-select').selectedIndex].text;
            const countryName = document.getElementById('country-search').value;
            
            getCurrentTime(timezone)
                .then(time => {
                    document.getElementById('time-result').textContent = 
                        `${countryName} - ${cityName}: ${time}`;
                })
                .catch(error => {
                    document.getElementById('time-result').textContent = 
                        `Error: Couldn't get time for ${cityName}`;
                });
        }
        
        // Start live updates for timezone
        function startLiveTime() {
            const timezone = document.getElementById('city-select').value;
            if (!timezone) {
                alert("Please select a city/timezone first");
                return;
            }
            
            const cityName = document.getElementById('city-select').options[document.getElementById('city-select').selectedIndex].text;
            const countryName = document.getElementById('country-search').value;
            
            // Clear existing interval
            const resultElement = document.getElementById('time-result');
            const oldIntervalId = resultElement.dataset.intervalId;
            if (oldIntervalId) clearInterval(parseInt(oldIntervalId));
            
            // Update immediately
            getCurrentTime(timezone)
                .then(time => {
                    resultElement.textContent = 
                        `${countryName} - ${cityName}: ${time}`;
                });
            
            // Update every second
            const intervalId = setInterval(() => {
                getCurrentTime(timezone)
                    .then(time => {
                        resultElement.textContent = 
                            `${countryName} - ${cityName}: ${time}`;
                    });
            }, 1000);
            
            resultElement.dataset.intervalId = intervalId;
        }
        
        // Pin a timezone
        function pinTimezone() {
            const timezone = document.getElementById('city-select').value;
            if (!timezone) {
                alert("Please select a city/timezone first");
                return;
            }
            
            const cityName = document.getElementById('city-select').options[document.getElementById('city-select').selectedIndex].text;
            const countryName = document.getElementById('country-search').value;
            
            if (!pinnedItems.timezones.some(tz => tz.id === timezone)) {
                pinnedItems.timezones.push({
                    id: timezone,
                    name: `${countryName} - ${cityName}`
                });
                savePinnedItems();
                renderPinnedItems();
            }
        }
        
        // ======================
        // CURRENCY FUNCTIONS
        // ======================
        
        // Convert currency
        function convertCurrency() {
            const from = document.getElementById('from-currency').value;
            const to = document.getElementById('to-currency').value;
            const amount = document.getElementById('amount').value || 1;
            
            document.getElementById('conversion-result').textContent = "Converting...";
            
            getCurrencyConversion(from, to, amount)
                .then(result => {
                    if (result === "N/A") {
                        document.getElementById('conversion-result').textContent = 
                            "API unavailable. Using approximate rate.";
                        showApproximateRate(from, to, amount);
                    } else {
                        document.getElementById('conversion-result').textContent = 
                            `${amount} ${from} = ${result} ${to}`;
                    }
                })
                .catch(error => {
                    document.getElementById('conversion-result').textContent = 
                        "Conversion failed. Using approximate rate.";
                    showApproximateRate(from, to, amount);
                });
        }
        
        // Show approximate rate when API fails
        function showApproximateRate(from, to, amount) {
            const approximateRates = {
                USD_KHR: 4017,
                EUR_KHR: 4689,
                THB_KHR: 115,
                KHR_USD: 0.00025,
                KHR_EUR: 0.00021,
                KHR_THB: 0.0087,
                USD_THB: 35,
                THB_USD: 0.029,
                EUR_THB: 41,
                THB_EUR: 0.024,
                // Added examples for new currencies (approximates as of August 19, 2025)
                USD_COP: 4017,  // ~1 USD ≈ 4017 COP
                COP_USD: 0.00025,
                USD_PLN: 3.85,  // ~1 USD ≈ 3.85 PLN
                PLN_USD: 0.26,
                USD_CVE: 100,   // ~1 USD ≈ 100 CVE
                CVE_USD: 0.01
                // Add more pairs as needed; focus on USD base for simplicity
            };
            
            const rateKey = `${from}_${to}`;
            if (approximateRates[rateKey]) {
                const result = (amount * approximateRates[rateKey]).toFixed(4);
                document.getElementById('conversion-result').textContent += 
                    `\nApproximate: ${amount} ${from} ≈ ${result} ${to}`;
            } else {
                document.getElementById('conversion-result').textContent += 
                    `\nNo approximate rate available for ${from} to ${to}.`;
            }
        }
        
        // Swap currency conversion
        function swapCurrencies() {
            const from = document.getElementById('from-currency');
            const to = document.getElementById('to-currency');
            const temp = from.value;
            from.value = to.value;
            to.value = temp;
            convertCurrency();
        }
        
        // Pin a currency pair
        function pinCurrency() {
            const from = document.getElementById('from-currency').value;
            const to = document.getElementById('to-currency').value;
            const id = `${from}_${to}`;
            
            if (!pinnedItems.currencies.some(curr => curr.id === id)) {
                pinnedItems.currencies.push({
                    id: id,
                    from: from,
                    to: to,
                    fromName: from.options[from.selectedIndex].text,
                    toName: to.options[to.selectedIndex].text
                });
                savePinnedItems();
                renderPinnedItems();
            }
        }
        
        // ======================
        // API FUNCTIONS
        // ======================
        
        // Get current time for a timezone
        async function getCurrentTime(timezone) {
            try {
                const response = await fetch(`https://worldtimeapi.org/api/timezone/${timezone}`);
                if (response.ok) {
                    const data = await response.json();
                    const date = new Date(data.datetime);
                    return date.toLocaleTimeString('en-US', {
                        timeZone: timezone,
                        hour12: false,
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                }
                return dayjs().tz(timezone).format('HH:mm:ss');
            } catch (error) {
                return dayjs().tz(timezone).format('HH:mm:ss');
            }
        }
        
        // Get currency conversion
        async function getCurrencyConversion(from, to, amount) {
            try {
                const response = await fetch(`https://open.er-api.com/v6/latest/${from}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.rates && data.rates[to]) {
                        return (amount * data.rates[to]).toFixed(4);
                    }
                }
                
                const altResponse = await fetch(`https://cdn.jsdelivr.net/gh/fawazahmed0/currency-api@1/latest/currencies/${from.toLowerCase()}/${to.toLowerCase()}.json`);
                if (altResponse.ok) {
                    const altData = await altResponse.json();
                    if (altData[to.toLowerCase()]) {
                        return (amount * altData[to.toLowerCase()]).toFixed(4);
                    }
                }
                
                return "N/A";
            } catch (error) {
                return "N/A";
            }
        }
        
        // ======================
        // PINNED ITEMS MANAGEMENT
        // ======================
        
        // Load pinned items from localStorage
        function loadPinnedItems() {
            const saved = localStorage.getItem('pinnedItems');
            if (saved) {
                pinnedItems = JSON.parse(saved);
                renderPinnedItems();
                startPinnedItemsUpdates();
            }
        }
        
        // Save pinned items to localStorage
        function savePinnedItems() {
            localStorage.setItem('pinnedItems', JSON.stringify(pinnedItems));
        }
        
        // Render all pinned items
        function renderPinnedItems() {
            renderPinnedTimezones();
            renderPinnedCurrencies();
        }
        
        // Render pinned timezones
        function renderPinnedTimezones() {
            const container = document.getElementById('pinned-timezones');
            container.innerHTML = '';
            
            pinnedItems.timezones.forEach(tz => {
                const item = document.createElement('div');
                item.className = 'list-group-item d-flex justify-content-between align-items-center';
                item.id = `pinned-tz-${tz.id.replace(/\//g, '-')}`;
                
                const content = document.createElement('div');
                content.innerHTML = `<strong>${tz.name}</strong><div class="time-display">Loading...</div>`;
                
                const button = document.createElement('button');
                button.className = 'btn btn-sm btn-danger';
                button.innerHTML = '<i class="bi bi-x"></i>';
                button.onclick = () => {
                    // Clear interval before removing
                    const display = content.querySelector('.time-display');
                    if (display && display.dataset.intervalId) {
                        clearInterval(parseInt(display.dataset.intervalId));
                    }
                    pinnedItems.timezones = pinnedItems.timezones.filter(item => item.id !== tz.id);
                    savePinnedItems();
                    renderPinnedItems();
                };
                
                item.appendChild(content);
                item.appendChild(button);
                container.appendChild(item);
                
                updatePinnedTimezone(tz.id, content.querySelector('.time-display'));
            });
        }
        
        // Render pinned currencies
        function renderPinnedCurrencies() {
            const container = document.getElementById('pinned-currencies');
            container.innerHTML = '';
            
            pinnedItems.currencies.forEach(curr => {
                const item = document.createElement('div');
                item.className = 'list-group-item d-flex justify-content-between align-items-center';
                item.id = `pinned-curr-${curr.id}`;
                
                const content = document.createElement('div');
                content.innerHTML = `<strong>${curr.fromName} → ${curr.toName}</strong><div class="conversion-display">Loading...</div>`;
                
                const button = document.createElement('button');
                button.className = 'btn btn-sm btn-danger';
                button.innerHTML = '<i class="bi bi-x"></i>';
                button.onclick = () => {
                    // Clear interval before removing
                    const display = content.querySelector('.conversion-display');
                    if (display && display.dataset.intervalId) {
                        clearInterval(parseInt(display.dataset.intervalId));
                    }
                    pinnedItems.currencies = pinnedItems.currencies.filter(item => item.id !== curr.id);
                    savePinnedItems();
                    renderPinnedItems();
                };
                
                item.appendChild(content);
                item.appendChild(button);
                container.appendChild(item);
                
                updatePinnedCurrency(curr.from, curr.to, content.querySelector('.conversion-display'));
            });
        }
        
        // Start updates for all pinned items
        function startPinnedItemsUpdates() {
            pinnedItems.timezones.forEach(tz => {
                const element = document.querySelector(`#pinned-tz-${tz.id.replace(/\//g, '-')} .time-display`);
                if (element) updatePinnedTimezone(tz.id, element);
            });
            
            pinnedItems.currencies.forEach(curr => {
                const element = document.querySelector(`#pinned-curr-${curr.id} .conversion-display`);
                if (element) updatePinnedCurrency(curr.from, curr.to, element);
            });
        }
        
        // Update a pinned timezone
        function updatePinnedTimezone(timezone, element) {
            getCurrentTime(timezone)
                .then(time => {
                    if (element) element.textContent = time;
                });
            
            const intervalId = setInterval(() => {
                getCurrentTime(timezone)
                    .then(time => {
                        if (element) element.textContent = time;
                    });
            }, 1000);
            
            if (element) element.dataset.intervalId = intervalId;
        }
        
        // Update a pinned currency
        function updatePinnedCurrency(from, to, element) {
            getCurrencyConversion(from, to, 1)
                .then(result => {
                    if (element) {
                        element.textContent = result === "N/A" ? "Rate unavailable" : `1 ${from} = ${result} ${to}`;
                    }
                });
            
            const intervalId = setInterval(() => {
                getCurrencyConversion(from, to, 1)
                    .then(result => {
                        if (element) {
                            element.textContent = result === "N/A" ? "Rate unavailable" : `1 ${from} = ${result} ${to}`;
                        }
                    });
            }, 60000);
            
            if (element) element.dataset.intervalId = intervalId;
        }
        
        // ======================
        // INITIALIZATION
        // ======================
        
        document.addEventListener('DOMContentLoaded', function() {
            updateLocalTime();
            setInterval(updateLocalTime, 1000);
            initCountrySearch();
            loadPinnedItems();
        });
    </script>
</body>
</html>